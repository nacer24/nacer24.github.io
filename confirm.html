<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Confirm Subscription</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>body{font-family:Arial, sans-serif; text-align:center; padding:40px}</style>
</head>
<body>
  <h2>Confirming your subscriptionâ€¦</h2>
  <p id="msg">Please wait...</p>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxKJMkmq5vah0o1RjR1xkXZrHzGXBe770xV0UrwQzvOBpPrxjFFZl3h_FgePCiza6lr/exec";
    const EBOOK_URL   = "https://nacer24.github.io/ebook.pdf";

    const params = new URLSearchParams(location.search);
    const email  = params.get("email");

    if (!email) {
      document.getElementById("msg").textContent = "Invalid confirmation link.";
    } else {
      getCountry().then(country => {
        return fetch(WEB_APP_URL, {
          method: "POST",
          body: new URLSearchParams({ action: "confirm", email, country })
        });
      })
      .then(() => { location.href = EBOOK_URL; })
      .catch(() => { document.getElementById("msg").textContent = "Error confirming subscription."; });
    }

    // Try two geo services (HTTPS + CORS). Fallback to "Unknown".
    async function getCountry() {
      // 1) ipapi.co
      try {
        const r = await fetch("https://ipapi.co/json/", { cache: "no-store" });
        if (r.ok) {
          const d = await r.json();
          if (d && d.country_name) return d.country_name;
        }
      } catch (_) {}

      // 2) ipwho.is
      try {
        const r2 = await fetch("https://ipwho.is/", { cache: "no-store" });
        if (r2.ok) {
          const d2 = await r2.json();
          if (d2 && d2.success && d2.country) return d2.country;
        }
      } catch (_) {}

      return "Unknown";
    }
  </script>
</body>
</html>


