<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Confirming…</title>
</head>
<body>

<p id="msg">Confirming your subscription…</p>

<script>
const WEB_APP_URL =
  "https://script.google.com/macros/s/AKfycbzdGSMXy0LdyQySXD-3B_j8zwepdX2pqTf3LqqzDy2aJX2ICRdmL9WPRwYpmv2w13o/exec";
const EBOOK_URL =
  "https://nacer24.github.io/ebook.pdf";

const p = new URLSearchParams(location.search);
const email = p.get("email");
const token = p.get("token");

if (!email || !token) {
  msg.textContent = "Invalid link.";
} else {
  fetch("https://ipapi.co/json/")
    .then(r => r.json())
    .then(d => d.country_name || "Unknown")
    .catch(() => "Unknown")
    .then(country => {
      fetch(WEB_APP_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "confirm",
          email,
          token,
          country
        })
      })
      .then(r => r.text())
      .then(t => {
        if (t === "OK") location.href = EBOOK_URL;
        else msg.textContent = t;
      });
    });
}
</script>

</body>
</html>

