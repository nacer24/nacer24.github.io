<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Confirm Subscription</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>

  <h2>Confirming your subscriptionâ€¦</h2>
  <p id="msg">Please wait...</p>

  <script>
    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycbxHeyAAmNQnivrYo2d38i0DUVJHnivayDTYiMWyPODsaPAflyXavxtoNuRWK-bUEAxq/exec";
    const EBOOK_URL =
      "https://nacer24.github.io/ebook.pdf";

    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");

    if (!email) {
      document.getElementById("msg").textContent =
        "Invalid confirmation link.";
    } else {
      getCountry()
        .then(country => {
          return fetch(WEB_APP_URL, {
            method: "POST",
            body: new URLSearchParams({
              action: "confirm",
              email: email,
              country: country
            })
          });
        })
        .then(res => res.text())
        .then(text => {
          if (text.trim() === "OK") {
            window.location.href = EBOOK_URL;
          } else {
            document.getElementById("msg").textContent =
              "Confirmation failed: " + text;
          }
        })
        .catch(err => {
          document.getElementById("msg").textContent =
            "Network error: " + err.message;
        });
    }

    async function getCountry() {
      try {
        const r = await fetch("https://ipapi.co/json/");
        if (r.ok) {
          const d = await r.json();
          if (d && d.country_name) return d.country_name;
        }
      } catch (_) {}
      return "Unknown";
    }
  </script>

</body>
</html>
