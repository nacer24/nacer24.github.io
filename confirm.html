<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Confirming Subscription</title>
</head>
<body>
  <p id="msg">Confirming your subscriptionâ€¦</p>

<script>
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbzp1GxfDYwmHdbWjHRtKdiU_BpWUPJ7U_0TLZd3jma_5xwiM4K835nzyL8gTnv2_57i/exec";

const EBOOK_URL = "https://nacer24.github.io/ebook.pdf";
const email = new URLSearchParams(window.location.search).get("email");

if (!email) {
  document.getElementById("msg").textContent = "Invalid confirmation link.";
} else {
  getCountry()
    .then(country =>
      fetch(WEB_APP_URL, {
        method: "POST",
        body: new URLSearchParams({ email, country })
      })
    )
    .then(res => res.text())
    .then(text => {
      if (text.trim() === "OK") {
        window.location.href = EBOOK_URL;
      } else {
        document.getElementById("msg").textContent = text;
      }
    })
    .catch(() => {
      document.getElementById("msg").textContent = "Confirmation failed.";
    });
}

async function getCountry() {
  try {
    const r = await fetch("https://ipapi.co/json/");
    if (r.ok) {
      const d = await r.json();
      return d.country_name || "Unknown";
    }
  } catch {}
  return "Unknown";
}
</script>
</body>
</html>
