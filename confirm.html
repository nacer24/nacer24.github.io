<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confirming Subscription</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; }
    #msg { font-size: 16px; }
  </style>
</head>
<body>

<h2>Confirming your subscription…</h2>
<p id="msg">Please wait...</p>

<script>
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbzp1GxfDYwmHdbWjHRtKdiU_BpWUPJ7U_0TLZd3jma_5xwiM4K835nzyL8gTnv2_57i/exec";
const EBOOK_URL = "https://nacer24.github.io/ebook.pdf";

const params = new URLSearchParams(location.search);
const email = params.get("email");
const token = params.get("token");

if (!email || !token) {
  document.getElementById("msg").textContent = "Invalid confirmation link.";
} else {
  getCountry()
    .then(country => {
      // Send confirm request to backend
      return fetch(WEB_APP_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "confirm",
          email: email,
          token: token,
          country: country
        })
      });
    })
    .then(res => res.text())
    .then(text => {
      if (text.trim() === "OK") {
        // Success → redirect to ebook
        location.href = EBOOK_URL;
      } else {
        document.getElementById("msg").textContent =
          "❌ Confirmation failed: " + text;
      }
    })
    .catch(err => {
      document.getElementById("msg").textContent =
        "❌ Network error: " + err.message;
    });
}

// Try to detect country (two services fallback)
async function getCountry() {
  // 1) ipwho.is
  try {
    const r = await fetch("https://ipwho.is/", { cache: "no-store" });
    if (r.ok) {
      const d = await r.json();
      if (d && d.success && d.country) return d.country;
    }
  } catch(_) {}

  // 2) ipapi.co
  try {
    const r2 = await fetch("https://ipapi.co/json/", { cache: "no-store" });
    if (r2.ok) {
      const d2 = await r2.json();
      if (d2 && d2.country_name) return d2.country_name;
    }
  } catch(_) {}

  return "Unknown";
}
</script>

</body>
</html>
